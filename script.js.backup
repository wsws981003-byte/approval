// 데이터 저장소
let sites = JSON.parse(localStorage.getItem('sites')) || [];
let approvals = JSON.parse(localStorage.getItem('approvals')) || [];
let currentUser = JSON.parse(localStorage.getItem('currentUser')) || null;
let userRequests = JSON.parse(localStorage.getItem('userRequests')) || [];
let approvedUsers = JSON.parse(localStorage.getItem('approvedUsers')) || [];
let deletedUsers = JSON.parse(localStorage.getItem('deletedUsers')) || [];

// 기본 대표님 계정 초기화 (최초 1회만 또는 삭제된 경우 복구)
function initializeDefaultCEO() {
    const defaultCEOUsername = 'admin';
    const existingAdmin = approvedUsers.find(u => u.username === defaultCEOUsername && u.role === 'ceo');
    
    // 기본 대표님 계정이 없으면 생성/복구
    if (!existingAdmin) {
        const defaultCEO = {
            username: defaultCEOUsername,
            password: 'admin123',
            role: 'ceo',
            name: '대표님',
            phone: '',
            email: '',
            approvedAt: new Date().toISOString(),
            approvedBy: 'system'
        };
        approvedUsers.push(defaultCEO);
        localStorage.setItem('approvedUsers', JSON.stringify(approvedUsers));
    }
}

// 초기화
function init() {
    // 기본 대표님 계정 초기화
    initializeDefaultCEO();
    
    // 로그인 상태 확인
    if (!currentUser) {
        showLoginModal();
        return;
    }
    
    showMainContent();
    loadSites();
    loadApprovals();
    updateDashboard();
    updateApprovalSites();
    updateSiteFilter();
    updateUIByRole();
}

// 로그인 모달 표시
function showLoginModal() {
    document.getElementById('loginModal').classList.add('active');
    document.getElementById('mainContainer').style.display = 'none';
}

// 메인 콘텐츠 표시
function showMainContent() {
    document.getElementById('loginModal').classList.remove('active');
    document.getElementById('mainContainer').style.display = 'block';
    updateUserInfo();
}

// 로그인 처리
function handleLogin(event) {
    event.preventDefault();
    const username = document.getElementById('loginUsername').value.trim();
    const password = document.getElementById('loginPassword').value;

    if (!username || !password) {
        alert('ID와 비밀번호를 입력해주세요.');
        return;
    }

    // 승인된 사용자인지 확인 (ID로만 검색)
    const approvedUser = approvedUsers.find(u => u.username === username);
    if (!approvedUser) {
        alert('승인되지 않은 사용자이거나 존재하지 않는 ID입니다. 대표님의 승인을 기다려주세요.');
        return;
    }

    // 비밀번호 확인 (간단한 체크 - 실제로는 해시 비교 필요)
    if (approvedUser.password !== password) {
        alert('비밀번호가 일치하지 않습니다.');
        return;
    }

    // 승인된 사용자의 역할을 자동으로 가져옴
    currentUser = {
        username: username,
        role: approvedUser.role, // 승인된 사용자의 역할 자동 설정
        loginTime: new Date().toISOString()
    };

    localStorage.setItem('currentUser', JSON.stringify(currentUser));
    showMainContent();
    init();
}

// 회원가입 모달 표시
function showRegisterModal() {
    document.getElementById('loginModal').classList.remove('active');
    document.getElementById('registerModal').classList.add('active');
}

// 회원가입 모달 닫기
function closeRegisterModal() {
    document.getElementById('registerModal').classList.remove('active');
    document.getElementById('registerModal').querySelector('form').reset();
    document.getElementById('loginModal').classList.add('active');
}

// 회원가입 처리
function handleRegister(event) {
    event.preventDefault();
    const username = document.getElementById('registerUsername').value.trim();
    const password = document.getElementById('registerPassword').value;
    const passwordConfirm = document.getElementById('registerPasswordConfirm').value;
    const role = document.getElementById('registerRole').value;
    const name = document.getElementById('registerName').value.trim();
    const phone = document.getElementById('registerPhone').value.trim();
    const email = document.getElementById('registerEmail').value.trim();

    if (!username || !password || !role || !name) {
        alert('필수 항목을 모두 입력해주세요.');
        return;
    }

    if (password !== passwordConfirm) {
        alert('비밀번호가 일치하지 않습니다.');
        return;
    }

    if (password.length < 4) {
        alert('비밀번호는 4자 이상이어야 합니다.');
        return;
    }

    // 이미 승인된 사용자인지 확인
    const existingApproved = approvedUsers.find(u => u.username === username);
    if (existingApproved) {
        alert('이미 가입된 사용자입니다.');
        return;
    }

    // 이미 대기 중인 요청이 있는지 확인
    const existingRequest = userRequests.find(r => r.username === username && r.status === 'pending');
    if (existingRequest) {
        alert('이미 회원가입 요청이 대기 중입니다.');
        return;
    }

    const request = {
        id: Date.now(),
        username: username,
        password: password, // 실제로는 해시화 필요
        role: role,
        name: name,
        phone: phone,
        email: email,
        status: 'pending',
        requestedAt: new Date().toISOString()
    };

    // 첫 번째 대표님 계정은 자동 승인
    const isFirstCEO = role === 'ceo' && approvedUsers.filter(u => u.role === 'ceo').length === 0;
    
    if (isFirstCEO) {
        // 자동 승인
        const approvedUser = {
            username: username,
            password: password,
            role: role,
            name: name,
            phone: phone,
            email: email,
            approvedAt: new Date().toISOString(),
            approvedBy: 'system'
        };
        approvedUsers.push(approvedUser);
        localStorage.setItem('approvedUsers', JSON.stringify(approvedUsers));
        
        request.status = 'approved';
        request.approvedAt = new Date().toISOString();
        request.approvedBy = 'system';
        
        alert('첫 번째 대표님 계정이 자동으로 승인되었습니다. 로그인해주세요.');
    } else {
        userRequests.push(request);
        localStorage.setItem('userRequests', JSON.stringify(userRequests));
        alert('회원가입 요청이 제출되었습니다. 대표님의 승인을 기다려주세요.');
    }
    
    closeRegisterModal();
}

// 로그아웃 처리
function handleLogout() {
    if (confirm('로그아웃 하시겠습니까?')) {
        currentUser = null;
        localStorage.removeItem('currentUser');
        showLoginModal();
        // 모든 섹션 숨기기
        document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
        document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active'));
    }
}

// 사용자 정보 업데이트
function updateUserInfo() {
    if (!currentUser) return;
    
    let roleText = '현장소장';
    if (currentUser.role === 'ceo') {
        roleText = '대표님';
    } else if (currentUser.role === 'admin_dept') {
        roleText = '관리부';
    }
    
    document.getElementById('userName').textContent = currentUser.username;
    document.getElementById('userRole').textContent = `(${roleText})`;
}

// 역할별 권한 체크
function hasPermission(action) {
    if (!currentUser) return false;
    
    // 대표님은 모든 권한
    if (currentUser.role === 'ceo') {
        return true;
    }
    
    // 현장소장 권한 체크
    if (currentUser.role === 'manager') {
        const managerPermissions = [
            'view_dashboard',
            'create_approval',
            'view_own_approvals',
            'approve_own_site',
            'reject_own_site'
        ];
        return managerPermissions.includes(action);
    }
    
    return false;
}

// 현장소장이 해당 현장의 담당자인지 확인
function isSiteManager(siteId) {
    if (!currentUser || currentUser.role !== 'manager') return false;
    const site = sites.find(s => s.id === siteId);
    return site && site.manager === currentUser.username;
}

// 역할에 따른 UI 업데이트
function updateUIByRole() {
    if (!currentUser) return;

    // 현장 관리 버튼 (대표님만)
    const addSiteButton = document.getElementById('addSiteButtonContainer');
    if (addSiteButton) {
        addSiteButton.style.display = hasPermission('manage_sites') ? 'block' : 'none';
    }

    // 현장 관리 메뉴 (대표님만)
    const sitesNavBtn = document.querySelector('.nav-btn[onclick="showSection(\'sites\')"]');
    if (sitesNavBtn) {
        sitesNavBtn.style.display = hasPermission('manage_sites') ? 'inline-block' : 'none';
    }

    // 회원가입 요청 관리 메뉴 (대표님만)
    const userRequestsNavBtn = document.getElementById('userRequestsNavBtn');
    if (userRequestsNavBtn) {
        userRequestsNavBtn.style.display = currentUser.role === 'ceo' ? 'inline-block' : 'none';
    }

    // 현장 삭제 버튼 (대표님만)
    loadSites();
    loadApprovals();
    loadPendingApprovals();
    
    // 회원가입 요청 목록 로드 (대표님만)
    if (currentUser.role === 'ceo') {
        loadUserRequests();
    }
}

// 섹션 전환
function showSection(sectionId, event) {
    document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
    document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active'));
    document.getElementById(sectionId).classList.add('active');
    
    // 클릭된 버튼에 active 클래스 추가
    if (event && event.target) {
        event.target.classList.add('active');
    } else {
        // 이벤트가 없으면 버튼을 찾아서 활성화
        const buttons = document.querySelectorAll('.nav-btn');
        buttons.forEach(btn => {
            if (btn.getAttribute('onclick') && btn.getAttribute('onclick').includes(sectionId)) {
                btn.classList.add('active');
            }
        });
    }
    
    if (sectionId === 'approvals') {
        loadApprovals();
    } else if (sectionId === 'pending') {
        loadPendingApprovals();
    } else if (sectionId === 'dashboard') {
        updateDashboard();
    } else if (sectionId === 'sites') {
        loadSites();
    } else if (sectionId === 'new-approval') {
        updateApprovalSites();
    } else if (sectionId === 'user-requests') {
        loadUserRequests();
    }
}

// 현장 관리
function loadSites() {
    const tbody = document.getElementById('sitesTableBody');
    if (sites.length === 0) {
        tbody.innerHTML = '<tr><td colspan="5" class="empty-state">등록된 현장이 없습니다.</td></tr>';
        return;
    }
    
    const canDelete = hasPermission('manage_sites');
    tbody.innerHTML = sites.map((site, index) => `
        <tr>
            <td>${site.name}</td>
            <td>${site.location}</td>
            <td>${site.manager}</td>
            <td>${site.steps}단계</td>
            <td>
                ${canDelete ? `<button class="btn btn-danger" onclick="deleteSite(${index})" style="padding: 5px 10px; font-size: 14px;">삭제</button>` : '<span style="color: #999;">-</span>'}
            </td>
        </tr>
    `).join('');
}

function showAddSiteModal() {
    document.getElementById('siteModal').classList.add('active');
}

function closeSiteModal() {
    document.getElementById('siteModal').classList.remove('active');
    document.getElementById('siteModal').querySelector('form').reset();
}

function addSite(event) {
    event.preventDefault();
    
    if (!hasPermission('manage_sites')) {
        alert('현장 관리 권한이 없습니다.');
        return;
    }
    
    const approvers = document.getElementById('siteApprovers').value.split(',').map(s => s.trim());
    const steps = parseInt(document.getElementById('siteSteps').value);
    
    if (approvers.length !== steps) {
        alert(`결재자 수(${approvers.length})와 결재 단계 수(${steps})가 일치하지 않습니다.`);
        return;
    }

    const site = {
        id: Date.now(),
        name: document.getElementById('siteName').value,
        location: document.getElementById('siteLocation').value,
        manager: document.getElementById('siteManager').value,
        steps: steps,
        approvers: approvers
    };

    sites.push(site);
    localStorage.setItem('sites', JSON.stringify(sites));
    loadSites();
    updateApprovalSites();
    updateSiteFilter();
    closeSiteModal();
    alert('현장이 추가되었습니다.');
}

function deleteSite(index) {
    if (!hasPermission('manage_sites')) {
        alert('현장 삭제 권한이 없습니다.');
        return;
    }
    
    if (confirm('정말 삭제하시겠습니까?')) {
        sites.splice(index, 1);
        localStorage.setItem('sites', JSON.stringify(sites));
        loadSites();
        updateApprovalSites();
        updateSiteFilter();
    }
}

function updateApprovalSites() {
    const select = document.getElementById('approvalSite');
    let availableSites = sites;
    
    // 현장소장은 자신이 담당하는 현장만 선택 가능
    if (currentUser && currentUser.role === 'manager') {
        availableSites = sites.filter(site => site.manager === currentUser.username);
    }
    
    select.innerHTML = '<option value="">현장을 선택하세요</option>' +
        availableSites.map(site => `<option value="${site.id}">${site.name}</option>`).join('');
    
    // 현장소장이면 작성자 이름 자동 입력
    if (currentUser && currentUser.role === 'manager') {
        const authorInput = document.getElementById('approvalAuthor');
        if (authorInput && !authorInput.value) {
            authorInput.value = currentUser.username;
        }
    }
}

function updateSiteFilter() {
    const select = document.getElementById('siteFilter');
    const currentValue = select.value;
    select.innerHTML = '<option value="">전체 현장</option>' +
        sites.map(site => `<option value="${site.id}">${site.name}</option>`).join('');
    select.value = currentValue;
}

// 결재 번호 생성 함수
function generateApprovalNumber() {
    const currentYear = new Date().getFullYear();
    const yearApprovals = approvals.filter(a => {
        const approvalYear = new Date(a.createdAt).getFullYear();
        return approvalYear === currentYear;
    });
    
    // 해당 연도의 결재 번호 중 가장 큰 번호 찾기
    let maxNumber = 0;
    yearApprovals.forEach(a => {
        if (a.approvalNumber) {
            const match = a.approvalNumber.match(/AP-\d{4}-(\d+)/);
            if (match) {
                const num = parseInt(match[1]);
                if (num > maxNumber) {
                    maxNumber = num;
                }
            }
        }
    });
    
    // 다음 번호 생성
    const nextNumber = maxNumber + 1;
    return `AP-${currentYear}-${String(nextNumber).padStart(3, '0')}`;
}

// 결재 관리
function submitApproval(event) {
    event.preventDefault();
    const siteId = parseInt(document.getElementById('approvalSite').value);
    const site = sites.find(s => s.id === siteId);
    
    if (!site) {
        alert('현장을 선택해주세요.');
        return;
    }

    const approval = {
        id: Date.now(),
        approvalNumber: generateApprovalNumber(),
        title: document.getElementById('approvalTitle').value,
        siteId: siteId,
        siteName: site.name,
        author: document.getElementById('approvalAuthor').value,
        content: document.getElementById('approvalContent').value,
        attachment: document.getElementById('approvalAttachment').value,
        status: 'pending',
        currentStep: 0,
        totalSteps: site.steps,
        approvers: [...site.approvers],
        approvals: Array(site.steps).fill(null),
        createdAt: new Date().toISOString()
    };

    approvals.push(approval);
    localStorage.setItem('approvals', JSON.stringify(approvals));
    document.getElementById('approvalForm').reset();
    alert('결재가 제출되었습니다.');
    showSection('approvals', null);
    loadApprovals();
    updateDashboard();
}

function loadApprovals() {
    const tbody = document.getElementById('approvalsTableBody');
    if (approvals.length === 0) {
        tbody.innerHTML = '<tr><td colspan="7" class="empty-state">결재 내역이 없습니다.</td></tr>';
        return;
    }
    
    const filtered = getFilteredApprovals();
    tbody.innerHTML = filtered.map(approval => {
        const canApprove = canUserApprove(approval);
        const showActions = (approval.status === 'pending' || approval.status === 'processing') && canApprove;
        
        return `
        <tr>
            <td>${approval.id}</td>
            <td>${approval.title}</td>
            <td>${approval.siteName}</td>
            <td>${approval.author}</td>
            <td><span class="badge badge-${getStatusClass(approval.status)}">${getStatusText(approval.status)}</span></td>
            <td>${formatDate(approval.createdAt)}</td>
            <td>
                <button class="btn btn-primary" onclick="viewApprovalDetail(${approval.id})" style="padding: 5px 10px; font-size: 14px;">상세</button>
                ${showActions ? 
                    `<button class="btn btn-success" onclick="approveStep(${approval.id})" style="padding: 5px 10px; font-size: 14px; margin-left: 5px;">승인</button>
                     <button class="btn btn-danger" onclick="rejectApproval(${approval.id})" style="padding: 5px 10px; font-size: 14px; margin-left: 5px;">반려</button>` : ''}
            </td>
        </tr>
    `;
    }).join('');
}

function loadPendingApprovals() {
    const tbody = document.getElementById('pendingTableBody');
    let pending = approvals.filter(a => a.status === 'pending' || a.status === 'processing');
    
    // 현장소장은 자신이 작성한 결재만 보기
    // 관리부와 대표님은 모든 결재를 볼 수 있음
    if (currentUser && currentUser.role === 'manager') {
        pending = pending.filter(a => a.author === currentUser.username);
    }
    
    if (pending.length === 0) {
        tbody.innerHTML = '<tr><td colspan="7" class="empty-state">대기 중인 결재가 없습니다.</td></tr>';
        return;
    }
    
    tbody.innerHTML = pending.map(approval => {
        const canApprove = canUserApprove(approval);
        const approvalNumber = approval.approvalNumber || approval.id;
        return `
        <tr>
            <td>${approvalNumber}</td>
            <td>${approval.title}</td>
            <td>${approval.siteName}</td>
            <td>${approval.author}</td>
            <td>${approval.currentStep + 1}/${approval.totalSteps} (${approval.approvers[approval.currentStep]})</td>
            <td>${formatDate(approval.createdAt)}</td>
            <td>
                <button class="btn btn-primary" onclick="viewApprovalDetail(${approval.id})" style="padding: 5px 10px; font-size: 14px;">상세</button>
                ${canApprove ? 
                    `<button class="btn btn-success" onclick="approveStep(${approval.id})" style="padding: 5px 10px; font-size: 14px; margin-left: 5px;">승인</button>
                     <button class="btn btn-danger" onclick="rejectApproval(${approval.id})" style="padding: 5px 10px; font-size: 14px; margin-left: 5px;">반려</button>` : 
                    '<span style="color: #999; font-size: 14px;">권한 없음</span>'}
            </td>
        </tr>
    `;
    }).join('');
}

function getFilteredApprovals() {
    const search = document.getElementById('searchInput').value.toLowerCase();
    const statusFilter = document.getElementById('statusFilter').value;
    const siteFilter = document.getElementById('siteFilter').value;
    
    let filtered = approvals.filter(approval => {
        const matchSearch = !search || approval.title.toLowerCase().includes(search);
        const matchStatus = !statusFilter || approval.status === statusFilter;
        const matchSite = !siteFilter || approval.siteId === parseInt(siteFilter);
        return matchSearch && matchStatus && matchSite;
    });
    
    // 현장소장은 자신이 작성한 결재만 보기
    // 관리부와 대표님은 모든 결재를 볼 수 있음
    if (currentUser && currentUser.role === 'manager') {
        filtered = filtered.filter(approval => 
            approval.author === currentUser.username
        );
    }
    // 관리부와 대표님은 필터링 없이 모든 결재 조회 가능
    
    return filtered;
}

// 사용자가 해당 결재를 승인할 수 있는지 확인
function canUserApprove(approval) {
    if (!currentUser) return false;
    
    // 대표님은 모든 결재 승인 가능
    if (currentUser.role === 'ceo') {
        return true;
    }
    
    // 관리부는 승인 권한 없음 (조회만 가능)
    if (currentUser.role === 'admin_dept') {
        return false;
    }
    
    // 현장소장은 자신이 담당하는 현장의 결재만 승인 가능
    if (currentUser.role === 'manager') {
        return isSiteManager(approval.siteId);
    }
    
    return false;
}

function filterApprovals() {
    loadApprovals();
}

function approveStep(approvalId) {
    const approval = approvals.find(a => a.id === approvalId);
    if (!approval) return;

    if (!canUserApprove(approval)) {
        alert('이 결재를 승인할 권한이 없습니다.');
        return;
    }

    // 현재 단계의 결재자 이름 확인
    const currentApproverName = approval.approvers[approval.currentStep];
    
    // 대표님이면 자동으로 이름 사용, 현장소장이면 확인
    let approver = currentUser.username;
    if (currentUser.role === 'ceo') {
        const confirmApprover = prompt(`결재자 이름을 입력하세요 (기본: ${currentUser.username}):\n현재 단계: ${currentApproverName}`, currentUser.username);
        if (confirmApprover === null) return;
        approver = confirmApprover || currentUser.username;
    } else if (currentUser.role === 'manager') {
        // 현장소장은 자신의 이름으로만 승인 가능
        if (currentApproverName !== currentUser.username && !approval.approvers.includes(currentUser.username)) {
            alert('현재 단계의 결재자가 아닙니다.');
            return;
        }
    }

    approval.approvals[approval.currentStep] = {
        approver: approver,
        approvedAt: new Date().toISOString(),
        status: 'approved'
    };

    approval.currentStep++;
    
    if (approval.currentStep >= approval.totalSteps) {
        approval.status = 'approved';
    } else {
        approval.status = 'processing';
    }

    localStorage.setItem('approvals', JSON.stringify(approvals));
    loadApprovals();
    loadPendingApprovals();
    updateDashboard();
    alert('승인되었습니다.');
}

function rejectApproval(approvalId) {
    const approval = approvals.find(a => a.id === approvalId);
    if (!approval) return;

    if (!canUserApprove(approval)) {
        alert('이 결재를 반려할 권한이 없습니다.');
        return;
    }

    const reason = prompt('반려 사유를 입력하세요:');
    if (reason === null || !reason.trim()) {
        if (reason === null) return;
        alert('반려 사유를 입력해주세요.');
        return;
    }

    const approver = currentUser.username;

    approval.status = 'rejected';
    approval.rejectedAt = new Date().toISOString();
    approval.rejectionReason = reason;
    approval.approvals[approval.currentStep] = {
        approver: approver,
        rejectedAt: new Date().toISOString(),
        status: 'rejected',
        reason: reason
    };

    localStorage.setItem('approvals', JSON.stringify(approvals));
    loadApprovals();
    loadPendingApprovals();
    updateDashboard();
    alert('반려되었습니다.');
}

function viewApprovalDetail(approvalId) {
    const approval = approvals.find(a => a.id === approvalId);
    if (!approval) return;

    const site = sites.find(s => s.id === approval.siteId);
    document.getElementById('detailTitle').textContent = approval.title;
    
    const approvalNumber = approval.approvalNumber || approval.id;
    let html = `
        <div style="margin-bottom: 20px;">
            <p><strong>결재 번호:</strong> ${approvalNumber}</p>
            <p><strong>현장:</strong> ${approval.siteName}</p>
            <p><strong>작성자:</strong> ${approval.author}</p>
            <p><strong>작성일:</strong> ${formatDate(approval.createdAt)}</p>
            <p><strong>상태:</strong> <span class="badge badge-${getStatusClass(approval.status)}">${getStatusText(approval.status)}</span></p>
        </div>
        <div style="margin-bottom: 20px;">
            <strong>내용:</strong>
            <div style="padding: 15px; background: #f8f9fa; border-radius: 8px; margin-top: 10px; white-space: pre-wrap;">${approval.content}</div>
        </div>
    `;

    if (approval.attachment) {
        html += `<div style="margin-bottom: 20px;"><strong>첨부:</strong> <a href="${approval.attachment}" target="_blank">${approval.attachment}</a></div>`;
    }

    html += '<div style="margin-top: 30px;"><strong>결재 라인:</strong>';
    for (let i = 0; i < approval.totalSteps; i++) {
        const approvalData = approval.approvals[i];
        const isCurrent = i === approval.currentStep && approval.status !== 'approved' && approval.status !== 'rejected';
        const isCompleted = approvalData && approvalData.status === 'approved';
        const isRejected = approvalData && approvalData.status === 'rejected';
        
        let className = 'approval-line';
        if (isCompleted) className += ' completed';
        if (isRejected) className += ' rejected';

        html += `
            <div class="${className}">
                <strong>${i + 1}단계: ${approval.approvers[i]}</strong>
                ${isCurrent ? '<span style="color: #ffc107;">⏳ 대기 중</span>' : ''}
                ${isCompleted ? `<span style="color: #28a745;">✓ 승인 완료 (${formatDate(approvalData.approvedAt)})</span>` : ''}
                ${isRejected ? `<span style="color: #dc3545;">✗ 반려 (${approvalData.reason || ''})</span>` : ''}
                ${!isCurrent && !isCompleted && !isRejected ? '<span style="color: #999;">대기 중</span>' : ''}
            </div>
        `;
    }
    html += '</div>';

    if (approval.rejectionReason) {
        html += `<div style="margin-top: 20px; padding: 15px; background: #fff3cd; border-radius: 8px;"><strong>반려 사유:</strong> ${approval.rejectionReason}</div>`;
    }

    document.getElementById('detailContent').innerHTML = html;
    document.getElementById('approvalDetailModal').classList.add('active');
}

function closeDetailModal() {
    document.getElementById('approvalDetailModal').classList.remove('active');
}

// 결재 삭제 (대표님만)
function deleteApproval(approvalId) {
    if (!currentUser || currentUser.role !== 'ceo') {
        alert('결재 삭제 권한이 없습니다.');
        return;
    }
    
    const approval = approvals.find(a => a.id === approvalId);
    if (!approval) {
        alert('결재를 찾을 수 없습니다.');
        return;
    }
    
    const approvalNumber = approval.approvalNumber || approval.id;
    if (confirm(`결재 번호 ${approvalNumber} (${approval.title})를 삭제하시겠습니까?\n\n이 작업은 되돌릴 수 없습니다.`)) {
        approvals = approvals.filter(a => a.id !== approvalId);
        localStorage.setItem('approvals', JSON.stringify(approvals));
        updateDashboard();
        loadApprovals();
        loadPendingApprovals();
        alert('결재가 삭제되었습니다.');
    }
}

// 대시보드 업데이트
function updateDashboard() {
    // 현장소장은 자신이 작성한 결재만 집계
    // 관리부와 대표님은 모든 결재를 집계
    let userApprovals = approvals;
    if (currentUser && currentUser.role === 'manager') {
        userApprovals = approvals.filter(a => a.author === currentUser.username);
    }
    
    const total = userApprovals.length;
    const pending = userApprovals.filter(a => a.status === 'pending' || a.status === 'processing').length;
    const approved = userApprovals.filter(a => a.status === 'approved').length;
    const rejected = userApprovals.filter(a => a.status === 'rejected').length;

    document.getElementById('totalApprovals').textContent = total;
    document.getElementById('pendingApprovals').textContent = pending;
    document.getElementById('approvedCount').textContent = approved;
    document.getElementById('rejectedCount').textContent = rejected;

    // 최근 결재 내역
    const recent = [...userApprovals].sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt)).slice(0, 5);
    const tbody = document.getElementById('recentTableBody');
    const canDelete = currentUser && currentUser.role === 'ceo';
    
    if (recent.length === 0) {
        tbody.innerHTML = '<tr><td colspan="7" class="empty-state">결재 내역이 없습니다.</td></tr>';
    } else {
        tbody.innerHTML = recent.map(approval => {
            const approvalNumber = approval.approvalNumber || approval.id;
            return `
            <tr>
                <td>${approvalNumber}</td>
                <td>${approval.title}</td>
                <td>${approval.siteName}</td>
                <td>${approval.author}</td>
                <td><span class="badge badge-${getStatusClass(approval.status)}">${getStatusText(approval.status)}</span></td>
                <td>${formatDate(approval.createdAt)}</td>
                <td>
                    ${canDelete ? `<button class="btn btn-danger" onclick="deleteApproval(${approval.id})" style="padding: 5px 10px; font-size: 14px;">삭제</button>` : '-'}
                </td>
            </tr>
        `;
        }).join('');
    }
}

// 유틸리티 함수
function getStatusClass(status) {
    const map = {
        'pending': 'pending',
        'processing': 'processing',
        'approved': 'approved',
        'rejected': 'rejected'
    };
    return map[status] || 'pending';
}

function getStatusText(status) {
    const map = {
        'pending': '대기 중',
        'processing': '진행 중',
        'approved': '승인 완료',
        'rejected': '반려'
    };
    return map[status] || '대기 중';
}

function formatDate(dateString) {
    const date = new Date(dateString);
    return date.toLocaleDateString('ko-KR') + ' ' + date.toLocaleTimeString('ko-KR', { hour: '2-digit', minute: '2-digit' });
}

// 모달 외부 클릭 시 닫기
window.onclick = function(event) {
    const siteModal = document.getElementById('siteModal');
    const detailModal = document.getElementById('approvalDetailModal');
    const registerModal = document.getElementById('registerModal');
    
    if (event.target === siteModal) {
        closeSiteModal();
    }
    if (event.target === detailModal) {
        closeDetailModal();
    }
    if (event.target === registerModal) {
        closeRegisterModal();
    }
}

// 회원가입 요청 목록 로드
function loadUserRequests() {
    const pendingRequests = userRequests.filter(r => r.status === 'pending');
    const tbody = document.getElementById('userRequestsTableBody');
    
    if (pendingRequests.length === 0) {
        tbody.innerHTML = '<tr><td colspan="8" class="empty-state">대기 중인 회원가입 요청이 없습니다.</td></tr>';
    } else {
        tbody.innerHTML = pendingRequests.map(request => {
            let roleText = '현장소장';
            if (request.role === 'ceo') {
                roleText = '대표님';
            } else if (request.role === 'admin_dept') {
                roleText = '관리부';
            }
            return `
                <tr>
                    <td>${request.id}</td>
                    <td>${request.username}</td>
                    <td>${request.name}</td>
                    <td>${roleText}</td>
                    <td>${request.phone || '-'}</td>
                    <td>${request.email || '-'}</td>
                    <td>${formatDate(request.requestedAt)}</td>
                    <td>
                        <button class="btn btn-success" onclick="approveUserRequest(${request.id})" style="padding: 5px 10px; font-size: 14px;">승인</button>
                        <button class="btn btn-danger" onclick="rejectUserRequest(${request.id})" style="padding: 5px 10px; font-size: 14px; margin-left: 5px;">거부</button>
                    </td>
                </tr>
            `;
        }).join('');
    }
    
    // 승인된 사용자 목록
    const approvedTbody = document.getElementById('approvedUsersTableBody');
    if (approvedUsers.length === 0) {
        approvedTbody.innerHTML = '<tr><td colspan="7" class="empty-state">승인된 사용자가 없습니다.</td></tr>';
    } else {
        approvedTbody.innerHTML = approvedUsers.map(user => {
            let roleText = '현장소장';
            if (user.role === 'ceo') {
                roleText = '대표님';
            } else if (user.role === 'admin_dept') {
                roleText = '관리부';
            }
            const isDefaultAdmin = user.username === 'admin' && user.role === 'ceo';
            return `
                <tr>
                    <td>${user.username}</td>
                    <td>${user.name}</td>
                    <td>${roleText}</td>
                    <td>${user.phone || '-'}</td>
                    <td>${user.email || '-'}</td>
                    <td>${formatDate(user.approvedAt)}</td>
                    <td>
                        ${isDefaultAdmin ? 
                            '<span style="color: #999; font-size: 14px;">삭제 불가</span>' : 
                            `<button class="btn btn-danger" onclick="removeApprovedUser('${user.username}')" style="padding: 5px 10px; font-size: 14px;">삭제</button>`}
                    </td>
                </tr>
            `;
        }).join('');
    }
    
    // 삭제된 사용자 목록
    const deletedTbody = document.getElementById('deletedUsersTableBody');
    if (deletedUsers.length === 0) {
        deletedTbody.innerHTML = '<tr><td colspan="8" class="empty-state">삭제된 사용자가 없습니다.</td></tr>';
    } else {
        deletedTbody.innerHTML = deletedUsers.map(user => {
            let roleText = '현장소장';
            if (user.role === 'ceo') {
                roleText = '대표님';
            } else if (user.role === 'admin_dept') {
                roleText = '관리부';
            }
            return `
                <tr style="opacity: 0.7;">
                    <td>${user.username}</td>
                    <td>${user.name}</td>
                    <td>${roleText}</td>
                    <td>${user.phone || '-'}</td>
                    <td>${user.email || '-'}</td>
                    <td>${formatDate(user.deletedAt)}</td>
                    <td>${user.deletedBy || '-'}</td>
                    <td>
                        <button class="btn btn-success" onclick="restoreDeletedUser('${user.username}')" style="padding: 5px 10px; font-size: 14px;">복구</button>
                        <button class="btn btn-danger" onclick="permanentlyDeleteUser('${user.username}')" style="padding: 5px 10px; font-size: 14px; margin-left: 5px;">영구 삭제</button>
                    </td>
                </tr>
            `;
        }).join('');
    }
}

// 회원가입 요청 승인
function approveUserRequest(requestId) {
    const request = userRequests.find(r => r.id === requestId);
    if (!request) return;

    if (confirm(`${request.name}(${request.username})님의 회원가입을 승인하시겠습니까?`)) {
        // 승인된 사용자 목록에 추가
        const approvedUser = {
            username: request.username,
            password: request.password,
            role: request.role,
            name: request.name,
            phone: request.phone,
            email: request.email,
            approvedAt: new Date().toISOString(),
            approvedBy: currentUser.username
        };

        approvedUsers.push(approvedUser);
        localStorage.setItem('approvedUsers', JSON.stringify(approvedUsers));

        // 요청 상태 업데이트
        request.status = 'approved';
        request.approvedAt = new Date().toISOString();
        request.approvedBy = currentUser.username;
        localStorage.setItem('userRequests', JSON.stringify(userRequests));

        loadUserRequests();
        alert('회원가입이 승인되었습니다.');
    }
}

// 회원가입 요청 거부
function rejectUserRequest(requestId) {
    const request = userRequests.find(r => r.id === requestId);
    if (!request) return;

    const reason = prompt('거부 사유를 입력하세요 (선택사항):');
    
    // 요청 상태 업데이트
    request.status = 'rejected';
    request.rejectedAt = new Date().toISOString();
    request.rejectedBy = currentUser.username;
    if (reason) {
        request.rejectionReason = reason;
    }
    localStorage.setItem('userRequests', JSON.stringify(userRequests));

    loadUserRequests();
    alert('회원가입 요청이 거부되었습니다.');
}

// 승인된 사용자 삭제
function removeApprovedUser(username) {
    // 기본 대표님 계정은 삭제 불가
    if (username === 'admin') {
        alert('기본 대표님 계정(admin)은 삭제할 수 없습니다.');
        return;
    }
    
    if (confirm(`${username} 사용자를 삭제하시겠습니까? 이 사용자는 더 이상 로그인할 수 없습니다.\n\n삭제된 계정은 나중에 복구할 수 있습니다.`)) {
        const userToDelete = approvedUsers.find(u => u.username === username);
        if (userToDelete) {
            // 삭제된 사용자 정보에 삭제 시간 추가
            const deletedUser = {
                ...userToDelete,
                deletedAt: new Date().toISOString(),
                deletedBy: currentUser ? currentUser.username : 'system'
            };
            deletedUsers.push(deletedUser);
            localStorage.setItem('deletedUsers', JSON.stringify(deletedUsers));
        }
        
        approvedUsers = approvedUsers.filter(u => u.username !== username);
        localStorage.setItem('approvedUsers', JSON.stringify(approvedUsers));
        loadUserRequests();
        alert('사용자가 삭제되었습니다.');
    }
}

// 기본 대표님 계정 복구
function restoreDefaultCEO() {
    const defaultCEOUsername = 'admin';
    const existingAdmin = approvedUsers.find(u => u.username === defaultCEOUsername && u.role === 'ceo');
    
    if (existingAdmin) {
        alert('기본 대표님 계정(admin)이 이미 존재합니다.');
        return;
    }
    
    if (confirm('기본 대표님 계정(admin)을 복구하시겠습니까?')) {
        const defaultCEO = {
            username: defaultCEOUsername,
            password: 'admin123',
            role: 'ceo',
            name: '대표님',
            phone: '',
            email: '',
            approvedAt: new Date().toISOString(),
            approvedBy: 'system'
        };
        approvedUsers.push(defaultCEO);
        localStorage.setItem('approvedUsers', JSON.stringify(approvedUsers));
        loadUserRequests();
        alert('기본 대표님 계정이 복구되었습니다.\nID: admin\n비밀번호: admin123');
    }
}

// 삭제된 사용자 복구
function restoreDeletedUser(username) {
    const deletedUser = deletedUsers.find(u => u.username === username);
    if (!deletedUser) {
        alert('삭제된 사용자를 찾을 수 없습니다.');
        return;
    }
    
    // 이미 승인된 사용자 목록에 있는지 확인
    const existingUser = approvedUsers.find(u => u.username === username);
    if (existingUser) {
        alert('이미 승인된 사용자 목록에 존재하는 사용자입니다.');
        return;
    }
    
    if (confirm(`${deletedUser.name}(${username}) 사용자를 복구하시겠습니까?`)) {
        // 삭제 정보 제거하고 승인된 사용자 목록에 추가
        const restoredUser = {
            username: deletedUser.username,
            password: deletedUser.password,
            role: deletedUser.role,
            name: deletedUser.name,
            phone: deletedUser.phone || '',
            email: deletedUser.email || '',
            approvedAt: deletedUser.approvedAt,
            approvedBy: deletedUser.approvedBy || 'system'
        };
        
        approvedUsers.push(restoredUser);
        localStorage.setItem('approvedUsers', JSON.stringify(approvedUsers));
        
        // 삭제된 사용자 목록에서 제거
        deletedUsers = deletedUsers.filter(u => u.username !== username);
        localStorage.setItem('deletedUsers', JSON.stringify(deletedUsers));
        
        loadUserRequests();
        alert('사용자가 복구되었습니다.');
    }
}

// 사용자 영구 삭제
function permanentlyDeleteUser(username) {
    if (confirm(`${username} 사용자를 영구적으로 삭제하시겠습니까?\n\n이 작업은 되돌릴 수 없습니다.`)) {
        deletedUsers = deletedUsers.filter(u => u.username !== username);
        localStorage.setItem('deletedUsers', JSON.stringify(deletedUsers));
        loadUserRequests();
        alert('사용자가 영구적으로 삭제되었습니다.');
    }
}

// 초기화 실행
if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', init);
} else {
    init();
}




